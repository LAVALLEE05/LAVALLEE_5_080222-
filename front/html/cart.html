<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>Cart</title>

    <meta charset="utf-8">
    <meta name="description" content="Plateforme incroyable de e-commerce">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/cart.css" rel="stylesheet" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <header>
      <div class="limitedWidthBlockContainer informations">
        <div class="limitedWidthBlock">
          <ul>
            <li><img src="../images/icons/phone.svg" alt="logo de téléphone" class="informations__phone">01 23 45 67 89</li>
            <li><img src="../images/icons/mail.svg" alt="logo d'une enveloppe" class="informations__mail">support@name.com</li>
            <li><img src="../images/icons/adress.svg" alt="logo d'un point de géolocalisation" class="informations__address">01 23 45 67 89</li>
          </ul>
        </div>
      </div>
      <div class="limitedWidthBlockContainer menu">
        <div class="limitedWidthBlock">
          <a href="./index.html">
            <img class="logo" src="../images/logo.png" alt="Logo de l'entreprise">
          </a>
          <nav>
            <ul>
              <a href="./index.html"><li>Accueil</li></a>
              <a href="./cart.html"><li>Panier</li></a>
            </ul>
          </nav>
        </div>
      </div>
      <img class="banniere" src="../images/banniere.png" alt="Baniere">
    </header>
    
    <main class="limitedWidthBlockContainer">
      <div class="limitedWidthBlock" id="limitedWidthBlock">
        <div class="cartAndFormContainer" id="cartAndFormContainer">
          <h1>Votre panier</h1>
          <section class="cart">
            <section id="cart__items">
             <!--  <article class="cart__item" data-id="{product-ID}" data-color="{product-color}">
                <div class="cart__item__img">
                  <img src="../images/product01.jpg" alt="Photographie d'un canapé">
                </div>
                <div class="cart__item__content">
                  <div class="cart__item__content__description">
                    <h2>Nom du produit</h2>
                    <p>Vert</p>
                    <p>42,00 €</p>
                  </div>
                  <div class="cart__item__content__settings">
                    <div class="cart__item__content__settings__quantity">
                      <p>Qté : </p>
                      <input type="number" class="itemQuantity" name="itemQuantity" min="1" max="100" value="42">
                    </div>
                    <div class="cart__item__content__settings__delete">
                      <p class="deleteItem">Supprimer</p>
                    </div>
                  </div>
                </div>
              </article> -->
            </section>
            <div class="cart__price">
              <p>Total (<span id="totalQuantity"><!-- 2 --></span> articles) : <span id="totalPrice"><!-- 84,00 --></span> €</p>
            </div>
            <div class="cart__order">
              <form method="get" class="cart__order__form">
                <div class="cart__order__form__question">
                  <label for="firstName">Prénom: </label>
                  <input type="text" name="firstName" id="firstName" required>
                  <p id="firstNameErrorMsg"><!-- ci est un message d'erreur --></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="lastName">Nom: </label>
                  <input type="text" name="lastName" id="lastName" required>
                  <p id="lastNameErrorMsg"></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="address">Adresse: </label>
                  <input type="text" name="address" id="address" required>
                  <p id="addressErrorMsg"></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="city">Ville: </label>
                  <input type="text" name="city" id="city" required>
                  <p id="cityErrorMsg"></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="email">Email: </label>
                  <input type="email" name="email" id="email" required>
                  <p id="emailErrorMsg"></p>
                </div>
                <div class="cart__order__form__submit">
                  <input type="submit" value="Commander !" id="order">
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </main>
    
    <footer>
      <div class="limitedWidthBlockContainer footerMain">
        <div class="limitedWidthBlock">
          <div>
            <img class="logo" src="../images/logo.png" alt="Logo de l'entreprise">
          </div>
          <div>
            <p>10 quai de la charente <br>75019 Paris 19</p>
          </div>
          <div>
            <p>Téléphone : 01 23 45 67 89</p>
          </div>
          <div>
            <p>Email : support@name.com</p>
          </div>
        </div>
      </div>
      <div class="limitedWidthBlockContainer footerSecondary">
        <div class="limitedWidthBlock">
          <p>© Copyright 2021 - 2042 | Openclassrooms by Openclassrooms | All Rights Reserved | Powered by <3</p>
        </div>
      </div>
    </footer>
  

  <script>

// recupération du localStorage 

let basket = getBasket()

if(basket.length ==  0){
    alert("votre panier est vide")
}

// mise à disposition du produit
  
for (let product of basket) {

  document.querySelector("#cart__items").innerHTML +=

  `<article class="cart__item" data-id="${product.id}" data-color="${product.color} ">
                            <div class="cart__item__img">
                              <img src="${product.image}" alt="${product.altTxt} ">
                            </div>
                            <div class="cart__item__content">
                              <div class="cart__item__content__description">
                                <h2>${product.name} </h2>
                                <p>${product.color}</p>
                                <p>${product.price}€</p>
                              </div>
                              <div class="cart__item__content__settings">
                                <div class="cart__item__content__settings__quantity">
                                  <p>Qté :  </p>
                                  <input type="number" class="itemQuantity" name="itemQuantity" min="1" max="100" value="${product.quantity}">
                                </div>
                                <div class="cart__item__content__settings__delete">
                                  <p class="deleteItem">Supprimer</p>
                                </div>
                              </div>
                            </div>
                          </article>`
}

// suppression du produit au click 
  
document.querySelectorAll(".deleteItem").forEach(item => item.addEventListener("click", (e) => {
      let deletItem = e.target.closest('[data-id]')
      let product = deletItem.dataset
      removeFromBasket(product)
      window.location.assign("cart.html")
}));

// changement du choix du produit
  
 document.querySelectorAll(".itemQuantity").forEach(item => item.addEventListener("change", (e) => {
      let quantity = e.target.closest('.itemQuantity').value
      let quantityNumber = parseInt(quantity)
      let deletItem = e.target.closest('[data-id]')
      let product = deletItem.dataset

      productID = {
        id: product.id,
        quantity: quantityNumber
    }

// suppression du produit en cas de probleme 
  
  if (quantityNumber <= 0 ){
          removeFromcart(productID)
          window.location.assign("cart.html")
  } else if (quantityNumber > 100){
          removeFromcart(productID)
          window.location.assign("cart.html")
  }else {
  
// ajout de la quantité si aucun probleme 
  
          addQuantity(productID)
      }
  }))

// affichage de la quantité et du prix total
  
setTotalQuantity()
setTotalPrice()

// formulaire de contact

let form = document.querySelector('.cart__order__form')

form.firstName.addEventListener('change', function(){ 
validNameCity(this)
})

form.lastName.addEventListener('change', function(){ 
validNameCity(this)
})

form.city.addEventListener('change', function(){ 
    validNameCity(this)
})

form.email.addEventListener('change', function(){ 
    validMail(this)
})

// si le formulaire est valide la redirection se fais sur la page de confirmation
  
 form.addEventListener("submit", function(e) {
      e.preventDefault()
      const firstName = document.getElementById('firstName').value
      const lastName = document.getElementById('lastName').value
      const address = document.getElementById('address').value
      const city = document.getElementById('city').value
      const email = document.getElementById('email').value
  
      contact = {
        firstName : firstName,
        lastName : lastName,
        address : address,
        city : city,
        email : email
    }

    if( validNameCity(form.firstName) == false){
        alert("merci de renseigner votre Prénom")

    }else if (validNameCity(form.lastName) == false){
        alert("merci de renseigner votre Nom")

    }else if (validNameCity(form.city) == false){
        alert("merci de renseigner votre Ville")

    }else if(validMail(form.email) == false){
        alert("merci de renseigner votre Email")

    }else if(basket.length == 0){
        alert("votre panier est vide")
        
    }else{
        saveContact(contact)
        window.location.assign("confirmation.html")
    }          
})

// enregistrement du panier dans le localStorage

function saveBasket(basket){
    localStorage.setItem("basket", JSON.stringify(basket));
}

// recuperation des produits du localStorage

function getBasket() {

  console.log(localStorage.getItem("basket"));

  let basket = localStorage.getItem("basket")
    if (basket == null) {
        return []
    } else {
        return JSON.parse(basket)
    }
}

// ajout du produit dans le panier - localStorage

function addBasket(product) {
    let basket = getBasket()

    console.log(basket)

    let foundProduct = basket.find(p => p.id == product.id) 
    if (foundProduct != undefined) {
        foundProduct.quantity += product.quantity

    } else {

        product.quantity = 1;
        basket.push(product)
    }

    saveBasket(basket)
}

// suppression des produits du panier - localStorage

function removeFromBasket(product){
    let basket = getBasket();
    basket = basket.filter(p => p.id != product.id);
    saveBasket(basket)
}

// recupération du nombre total de produit du localStorage 

function getNumberProduct() {
    let basket = getBasket()
    let number = 0
    for (let product of basket) {
        number += product.quantity
    }
    return number
}

// récupération du prix total des produits du localStorage 

function getTotalPrice() {
    let basket = getBasket()
    let total = 0
    for (let product of basket) {
        total += product.quantity * product.price
    }
    return total
}


 // affichage de la quantité totale du panier
  
 function setTotalQuantity() {
    let totalQuantity = document.getElementById('totalQuantity')
    let newQuantity = document.createTextNode(`${getNumberProduct()}`)
    if (newQuantity != undefined) {
        totalQuantity.replaceChild(newQuantity, totalQuantity.childNodes[0])

    } else {
        totalQuantity.appendChild(newQuantity)
    }
}

// gestion de l'ajout de quantité 

function addQuantity(product) {
    let basket = getBasket()
    let foundProduct = basket.find(p => p.id == product.id)
    if (foundProduct != undefined) {
        foundProduct.quantity = product.quantity
    }

    saveBasket(basket)
    setTotalQuantity()
    setTotalPrice()
}

// affichage du prix total

function setTotalPrice() {
    let totalPrice = document.getElementById('totalPrice')
    let newPrice = document.createTextNode(`${getTotalPrice()}`)
    if (newPrice != undefined) {
        totalPrice.replaceChild(newPrice, totalPrice.childNodes[0])
    } else {
        totalPrice.appendChild(newPrice)
    }
}

// regex nom, prénom et ville

function validNameCity (inputName){
    let nameRegexp = new RegExp (/^[a-z ,.'-]+$/i)

    let testName = nameRegexp.test(inputName.value)
    let messageName = inputName.nextElementSibling
    if(testName){
        messageName.innerHTML = ""
        return true
    }else{
        messageName.innerHTML = "Invalide"
        return false
    }
}

// regex mail 

  function validMail (inputMail){
    let mailRegexp = new RegExp (/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i)
    let testMail = mailRegexp.test(inputMail.value)
    let messageMail = inputMail.nextElementSibling
    if(testMail){
        messageMail.innerHTML = ""
        return true
    }else{
        messageMail.innerHTML = "Invalide"
        return false
    }
}

// envoi de l'objet contact dans le localStorage 

function saveContact(contact){
    localStorage.setItem("contact", JSON.stringify(contact))
}

// recupération de l'objet contact du localStorage 

function getContact() {
    let contact = localStorage.getItem("contact")
    if (contact == null) {
        return []
    } else {
        return JSON.parse(contact)
    }
}
  </script>

  </body>
</html>